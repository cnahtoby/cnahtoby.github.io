## 一、漏洞原理

### 1、简介

```python
# 解释
目录遍历（Directory Traversal），也称目录穿越。由于WEB服务器或者WEB应用程序对用户输入的文件名称校验不足，导致攻击者可以通过利用特殊字符绕过安全限制，访问任意文件/执行系统命令。
```

```python
# 危害
1、信息泄露，任意用户可读取系统敏感文件
2、命令执行
```



## 二、漏洞特征

### 1、场景

```python
# 功能点
1、文件导出/下载
2、查询服务器内容
```

### 2、发现

```python
# Google Hack
intitle:Index of
inurl:?file=
inurl:?filename=
```



## 三、利用条件

### 1、存在文件调用路径

### 2、网站服务正常



## 四、利用方法

### 1、../

### 2、绝对路径



## 五、绕过防护

### 1、加密传输

```python
找到参数解密方式，构造Payload，加密输入
```

### 2、关键字过滤

```
URL编码
双写../
绝对路径
```

### 2、目录限定

```
~
```

### 3、文件后缀过滤

```python
# 截断
Windows：index%00.jsp
Linux：index.jsp%20
```

### 4、来源

```
修改成正常Referer
```



## 六、实战思路

### 1、查看功能点

```
网站都在哪些功能点进行调用资源？
```

### 2、查看数据传输

```
有无URL？
URL存在于数据包的什么位置？
```

### 3、漏洞判断

```python
1、访问http://127.0.0.1/pikachu-master/install.php，猜测这是否为根目录
2、点击网页中的功能点，进入下一级
3、访问http://127.0.0.1/pikachu-master/vul/dir.php?title=../../install.php，返回和第一步相同，此处则存在目录遍历漏洞
```

### 4、漏洞验证

```python
Linux:
http://127.0.0.1/pikachu-master/vul/dir.php?title=../../../../../../../etc/passwd
Windows：
http://127.0.0.1/pikachu-master/vul/dir.php?title=..\..\..\..\..\..\C:\windows\win.ini
```



## 七、防护措施

### 1、字符过滤

```
目录跳转符
字符截断符
dir
...
```

### 2、加密传输

### 3、身份校验

```
Cookie
Referer
```

### 4、中间件方案

```python
# IIS
关闭目录浏览功能：IIS网站属性中，取消勾选"目录浏览"选项，重启IIS。
```

```python
# Apache
关闭目录浏览功能：打开Apache配置文件httpd.conf，查找"Options Indexes FollowSymLinks"，修改为"Options -Indexes"（减号表示取消），保存退出，重启Apache。
```

```python
# Nginx
不开启目录浏览功能：Nginx默认不开启目录浏览功能，若当前已开启，可编辑nginx.conf文件，删除如下两行
autoindex on;
autoindex_exact_size on;
重启Nginx。
```



## 八、常用工具

### 1、Dirsearch

```python
# 解释
Dirsearch是一款Python开发的扫描工具，主要用于扫描网站的敏感文件和目录
```

```python
# 下载
https://github.com/maurosoria/dirsearch
```

```python
# 参数
-u			   网址
-e			   文件类型
-w			   字典
-r			   递归目录
-random-agents	使用随机UA
```

```python
# 用法
python3 dirsearch.py -u [url]
```



## 九、其他补充

### 1、常见敏感文件路径

```python
# Linux
/etc/passwd // 账户信息
/etc/shadow // 账户密码文件
/usr/local/app/apache2/conf/httpd.conf // Apache2默认配置文件
/usr/local/app/apache2/conf/extra/httpd-vhost.conf // 虚拟网站配置
/usr/local/app/php5/lib/php.ini // PHP相关配置
/etc/httpd/conf/httpd.conf // Apache配置文件
/etc/my.conf // mysql 配置文件
```

```python
# Windows
c:\boot.ini // 查看系统版本
c:\windows\system32\inetsrv\MetaBase.xml // IIS配置文件
c:\windows\repair\sam // 存储Windows系统初次安装的密码
c:\ProgramFiles\mysql\my.ini // MySQL配置
c:\ProgramFiles\mysql\data\mysql\user.MYD // MySQL root密码
c:\windows\php.ini // php 配置信息
```

### 2、数据包分析

​	1.1、打开数据包，追踪HTTP数据流，URL中存在../字符，那么此数据包可能涉及目录遍历漏洞

​	1.2、根据响应数据包的状态码和响应正文判断是否攻击成功

